<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iris - ÊúçÂä°Âô®ÁõëÊéß</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/uplot@1.6.24/dist/uPlot.min.css">
    <script src="https://unpkg.com/uplot@1.6.24/dist/uPlot.iife.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f7f8fa;
            --bg-tertiary: #f0f1f3;
            --border-color: #e5e7eb;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --text-tertiary: #9ca3af;
            --accent-primary: #0066ff;
            --accent-hover: #0052cc;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'SF Pro Display', 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app {
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 12px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(8px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-title h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-badge {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            font-weight: 500;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px;
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
        }

        .status-card {
            background: var(--bg-primary);
            border-radius: var(--radius-md);
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s;
        }

        .status-card:hover {
            box-shadow: var(--shadow-md);
        }

        .status-indicator {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .status-indicator.healthy {
            background: #d1fae5;
        }

        .status-indicator.warning {
            background: #fef3c7;
        }

        .status-indicator.critical {
            background: #fee2e2;
        }

        .status-content {
            flex: 1;
        }

        .status-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .status-description {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-unit {
            font-size: 14px;
            color: var(--text-tertiary);
            margin-left: 4px;
        }

        /* Agents Grid */
        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 12px;
        }

        .agent-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
            border-color: var(--accent-primary);
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .agent-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .agent-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
        }

        .status-online {
            background: #d1fae5;
            color: #065f46;
        }

        .status-offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: currentColor;
        }

        .agent-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 11px;
            color: var(--text-secondary);
            padding: 6px 10px;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }

        .agent-meta-item {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .agent-meta-item:not(:last-child)::after {
            content: '|';
            margin-left: 8px;
            color: var(--border-color);
        }

        .agent-meta-item .value {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Network Stats */
        .network-stats {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .network-stat {
            flex: 1;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 6px 8px;
        }

        .network-stat-header {
            display: flex;
            align-items: center;
            gap: 3px;
            margin-bottom: 2px;
        }

        .network-stat-icon {
            font-size: 11px;
        }

        .network-stat-label {
            font-size: 9px;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .network-stat-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .network-trend {
            font-size: 10px;
            font-weight: 600;
        }

        .network-stat-value.trend-up {
            color: var(--success);
        }

        .network-stat-value.trend-down {
            color: var(--danger);
        }

        .network-stat-value.trend-neutral {
            color: var(--text-primary);
        }

        .network-stat-total {
            font-size: 8px;
            color: var(--text-tertiary);
            margin-top: 1px;
        }

        /* Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
        }

        .metric {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 6px 8px;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .metric-label {
            font-size: 10px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .metric-bar {
            height: 3px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .metric-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .metric-bar-fill.cpu { background: var(--accent-primary); }
        .metric-bar-fill.memory { background: var(--warning); }
        .metric-bar-fill.disk { background: var(--success); }

        .metric-total {
            font-size: 9px;
            color: var(--text-tertiary);
            margin-bottom: 3px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
            backdrop-filter: blur(4px);
        }

        .modal {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-subtitle {
            margin-top: 2px;
            font-size: 12px;
            color: var(--text-tertiary);
            font-family: 'SF Mono', Monaco, monospace;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-tertiary);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 16px;
            overflow-y: auto;
        }

        .section {
            margin-bottom: 20px;
        }

        .section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 2px solid var(--accent-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-title .icon {
            font-size: 14px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }

        .dashboard-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
        }

        .dashboard-card-title {
            font-size: 11px;
            color: var(--text-secondary);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .dashboard-card-value {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 6px;
        }

        .dashboard-card-subtitle {
            font-size: 10px;
            color: var(--text-tertiary);
        }

        .dashboard-card-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .trend-positive {
            color: var(--success);
        }

        .trend-negative {
            color: var(--danger);
        }

        /* Charts Row */
        .charts-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .chart-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 10px 12px;
        }

        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .chart-card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chart-card-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-card-body {
            height: 150px;
        }

        .chart-container {
            height: 200px;
            margin-bottom: 12px;
        }

        /* uPlot ÂõæË°®Ê†∑Âºè‰ºòÂåñ */
        .uplot {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .uplot .u-legend {
            font-size: 10px;
        }

        .uplot .u-series {
            font-size: 10px;
        }

        .uplot .u-value {
            font-size: 10px;
        }

        .uplot .u-label {
            font-size: 9px;
        }

        .uplot .u-legend .u-marker {
            width: 8px;
            height: 8px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
        }

        .info-item {
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 8px 10px;
        }

        .info-item-label {
            font-size: 10px;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .info-item-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Table */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .table th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table td {
            font-size: 14px;
            color: var(--text-primary);
        }

        .table tbody tr:hover {
            background: var(--bg-secondary);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error */
        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 16px;
            border-radius: var(--radius-md);
            margin: 20px 0;
            border: 1px solid #fecaca;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .agents-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .charts-row {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 16px;
            }

            .modal {
                max-height: 95vh;
            }
        }

        @media (max-width: 480px) {
            .header-content {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .table {
                font-size: 12px;
            }

            .table th,
            .table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Êï∞Â≠óÂä®Áîª Hook
        const useCountUp = (end, duration = 1000, decimals = 1) => {
            const [count, setCount] = useState(end);
            const requestRef = useRef(null);

            useEffect(() => {
                const startTime = performance.now();
                const startValue = count;
                const endValue = parseFloat(end) || 0;

                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);

                    // ‰ΩøÁî® easeOutQuart ÁºìÂä®ÂáΩÊï∞
                    const easeProgress = 1 - Math.pow(1 - progress, 4);

                    const current = startValue + (endValue - startValue) * easeProgress;
                    setCount(parseFloat(current.toFixed(decimals)));

                    if (progress < 1) {
                        requestRef.current = requestAnimationFrame(animate);
                    }
                };

                requestRef.current = requestAnimationFrame(animate);

                return () => {
                    if (requestRef.current) {
                        cancelAnimationFrame(requestRef.current);
                    }
                };
            }, [end, duration, decimals]);

            return count;
        };

        // Utility functions
        const formatBytes = (bytes) => {
            if (!bytes) return 'N/A';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(2)} ${units[unitIndex]}`;
        };

        const formatBytesShort = (bytes) => {
            if (!bytes) return 'N/A';
            const units = ['B', 'KB', 'MB', 'GB', 'TB'];
            let size = bytes;
            let unitIndex = 0;
            while (size >= 1024 && unitIndex < units.length - 1) {
                size /= 1024;
                unitIndex++;
            }
            return `${size.toFixed(1)}${units[unitIndex]}`;
        };

        const formatSpeed = (bytesPerSec) => {
            if (!bytesPerSec || bytesPerSec < 0) return '0 B/s';
            const units = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            let speed = bytesPerSec;
            let unitIndex = 0;
            while (speed >= 1024 && unitIndex < units.length - 1) {
                speed /= 1024;
                unitIndex++;
            }
            return `${speed.toFixed(1)} ${units[unitIndex]}`;
        };

        const formatUptime = (seconds) => {
            if (!seconds) return 'N/A';
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (days > 0) return `${days}Â§© ${hours}Êó∂`;
            if (hours > 0) return `${hours}Êó∂ ${minutes}ÂàÜ`;
            return `${minutes}ÂàÜ`;
        };

        const formatTime = (timestamp) => {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return `${diff}ÁßíÂâç`;
            if (diff < 3600) return `${Math.floor(diff / 60)}ÂàÜÈíüÂâç`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}Â∞èÊó∂Ââç`;
            return date.toLocaleString('zh-CN');
        };

        // Components
        const AnimatedNumber = ({ value, duration = 1000, decimals = 1, startFromZero = false }) => {
            const [initialized, setInitialized] = useState(!startFromZero);
            const displayValue = initialized ? value : 0;

            useEffect(() => {
                if (startFromZero && !initialized) {
                    setInitialized(true);
                }
            }, [startFromZero, initialized]);

            const count = useCountUp(displayValue, duration, decimals);
            return <>{count}</>;
        };

        // Áî®‰∫éÊòæÁ§∫Â∏¶Âçï‰ΩçÁöÑÂä®ÁîªÊï∞Â≠ó
        const AnimatedValue = ({ value, duration = 600 }) => {
            // ÊèêÂèñÊï∞Â≠óÈÉ®ÂàÜÂíåÂçï‰ΩçÈÉ®ÂàÜ
            const match = value.toString().match(/^([\d.]+)\s*(.*)$/);
            if (!match) return <>{value}</>;

            const numValue = parseFloat(match[1]);
            const unit = match[2];

            return (
                <>
                    <AnimatedNumber value={numValue} duration={duration} decimals={1} />
                    {unit && <>{unit}</>}
                </>
            );
        };

        const StatCard = ({ label, value, unit }) => (
            <div className="stat-card">
                <div className="stat-label">{label}</div>
                <div className="stat-value">
                    <AnimatedNumber value={parseFloat(value) || 0} duration={800} decimals={0} startFromZero={true} />
                    {unit && <span className="stat-unit">{unit}</span>}
                </div>
            </div>
        );

        const StatusCard = ({ onlineCount, offlineCount, agents }) => {
            // Âà§Êñ≠Á≥ªÁªüÁä∂ÊÄÅ
            let status = 'healthy';
            let icon = '‚úì';
            let title = 'Á≥ªÁªüÊ≠£Â∏∏';
            let description = `${onlineCount} ‰∏™ Agent Âú®Á∫ø`;

            if (offlineCount > 0) {
                description += `Ôºå${offlineCount} ‰∏™Á¶ªÁ∫ø`;
            }

            if (onlineCount === 0) {
                status = 'critical';
                icon = '‚úï';
                title = 'Êó†Âú®Á∫ø Agent';
                description = `ÊâÄÊúâ Agent ÂùáÂ∑≤Á¶ªÁ∫øÔºàÂÖ± ${offlineCount} ‰∏™Ôºâ`;
            } else {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈ´òË¥üËΩΩÁöÑ agent
                const highCpuAgents = agents.filter(a => a.system?.cpu?.usage_percent > 80);
                const highMemAgents = agents.filter(a => a.system?.memory?.usage_percent > 85);

                if (highCpuAgents.length > 0 || highMemAgents.length > 0) {
                    status = 'warning';
                    icon = '‚ö†';
                    title = 'Ê£ÄÊµãÂà∞ÂºÇÂ∏∏';
                    const issues = [];
                    if (highCpuAgents.length > 0) issues.push(`${highCpuAgents.length} ‰∏™ CPU ËøáÈ´ò`);
                    if (highMemAgents.length > 0) issues.push(`${highMemAgents.length} ‰∏™ÂÜÖÂ≠òËøáÈ´ò`);
                    description = `${onlineCount} ‰∏™Âú®Á∫øÔºà${issues.join('Ôºå')}Ôºâ`;
                    if (offlineCount > 0) {
                        description += `Ôºå${offlineCount} ‰∏™Á¶ªÁ∫ø`;
                    }
                } else if (offlineCount > 0) {
                    // ÊúâÁ¶ªÁ∫ø‰ΩÜÊ≤°ÊúâÂºÇÂ∏∏ÔºåÊòæÁ§∫Ë≠¶Âëä
                    status = 'warning';
                    icon = '‚ö†';
                    title = 'ÈÉ®ÂàÜ Agent Á¶ªÁ∫ø';
                }
            }

            return (
                <div className="status-card">
                    <div className={`status-indicator ${status}`}>
                        {icon}
                    </div>
                    <div className="status-content">
                        <div className="status-title">{title}</div>
                        <div className="status-description">{description}</div>
                    </div>
                </div>
            );
        };

        const MetricCard = ({ label, value, percent, type, total }) => {
            const numValue = parseFloat(value) || 0;
            const hasPercent = typeof value === 'string' && value.includes('%');

            return (
                <div className="metric">
                    <div className="metric-header">
                        <span className="metric-label">{label}</span>
                        <span className="metric-value">
                            <AnimatedNumber value={numValue} duration={600} decimals={1} />
                            {hasPercent && '%'}
                        </span>
                    </div>
                    {total && (
                        <div className="metric-total">{total}</div>
                    )}
                    <div className="metric-bar">
                        <div className={`metric-bar-fill ${type}`} style={{ width: `${percent}%` }} />
                    </div>
                </div>
            );
        };

        const AgentCard = ({ agent, onClick }) => {
            const sys = agent.system;
            const cpu = sys?.cpu?.usage_percent?.toFixed(1) || 0;
            const memory = sys?.memory?.usage_percent?.toFixed(1) || 0;
            const disk = sys?.disks?.[0]?.usage_percent?.toFixed(1) || 0;
            const load = sys?.cpu?.load_avg_1?.toFixed(2) || 0;
            const uptime = formatUptime(sys?.system_info?.uptime);
            const cpuCores = sys?.cpu?.core_count || 'N/A';
            const totalMemory = formatBytes(sys?.memory?.total);

            // ËÆ°ÁÆóÂÖ∑‰ΩìÁöÑÂ∑≤Áî®ÂÄº
            const cpuUsage = ((cpu / 100) * cpuCores).toFixed(2);
            const memoryUsed = formatBytes(sys?.memory?.used);
            const diskUsed = formatBytes(sys?.disks?.[0]?.used);
            const diskTotal = formatBytes(sys?.disks?.[0]?.total);

            // ÁΩëÁªú‰ø°ÊÅØ
            const network = sys?.network;
            const uploadSpeed = formatSpeed(agent.network_speed?.upload || 0);
            const downloadSpeed = formatSpeed(agent.network_speed?.download || 0);
            const totalSent = formatBytesShort(network?.bytes_sent);
            const totalRecv = formatBytesShort(network?.bytes_recv);

            // ËÆ°ÁÆóÁΩëÁªúË∂ãÂäø
            const prevUploadSpeed = agent.prev_network_speed?.upload || 0;
            const prevDownloadSpeed = agent.prev_network_speed?.download || 0;
            const currentUploadSpeed = agent.network_speed?.upload || 0;
            const currentDownloadSpeed = agent.network_speed?.download || 0;

            const uploadTrend = currentUploadSpeed > prevUploadSpeed ? 'up' :
                               currentUploadSpeed < prevUploadSpeed ? 'down' : 'neutral';
            const downloadTrend = currentDownloadSpeed > prevDownloadSpeed ? 'up' :
                                 currentDownloadSpeed < prevDownloadSpeed ? 'down' : 'neutral';

            // Âà§Êñ≠Âú®Á∫øÁä∂ÊÄÅÔºöÂ¶ÇÊûúÊúÄÂêé‰∏ÄÊ¨°ÂøÉË∑≥Ë∂ÖËøá 10 ÁßíÔºåÂàôËÆ§‰∏∫Á¶ªÁ∫ø
            const now = Date.now();
            const lastSeen = agent.timestamp * 1000; // ËΩ¨Êç¢‰∏∫ÊØ´Áßí
            const isOnline = (now - lastSeen) < 10000; // 10 ÁßíË∂ÖÊó∂

            const getTrendIcon = (trend) => {
                if (trend === 'up') return '‚Üë';
                if (trend === 'down') return '‚Üì';
                return '‚àí';
            };

            return (
                <div className="agent-card" onClick={() => onClick(agent)}>
                        <div className="agent-header">
                            <div>
                                <div className="agent-name">{agent.hostname}</div>
                            </div>
                            <span className={`agent-status ${isOnline ? 'status-online' : 'status-offline'}`}>
                                <span className="status-dot"></span>
                                {isOnline ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'}
                            </span>
                    </div>
                    <div className="agent-meta">
                        <div className="agent-meta-item">
                            <span className="value">{cpuCores}Ê†∏</span>
                        </div>
                        <div className="agent-meta-item">
                            <span className="value">{totalMemory}</span>
                        </div>
                        <div className="agent-meta-item">
                            <span className="value">{sys?.system_info?.os_name}</span>
                        </div>
                        <div className="agent-meta-item">
                            <span className="value">{uptime}</span>
                        </div>
                    </div>

                    {network && (
                        <div className="network-stats">
                            <div className="network-stat">
                                <div className="network-stat-header">
                                    <span className="network-stat-icon">‚¨ÜÔ∏è</span>
                                    <span className="network-stat-label">‰∏ä‰º†</span>
                                </div>
                                <div className={`network-stat-value trend-${uploadTrend}`}>
                                    <AnimatedValue value={uploadSpeed} />
                                    <span className="network-trend">
                                        {getTrendIcon(uploadTrend)}
                                    </span>
                                </div>
                                <div className="network-stat-total">ÊÄªËÆ° {totalSent}</div>
                            </div>
                            <div className="network-stat">
                                <div className="network-stat-header">
                                    <span className="network-stat-icon">‚¨áÔ∏è</span>
                                    <span className="network-stat-label">‰∏ãËΩΩ</span>
                                </div>
                                <div className={`network-stat-value trend-${downloadTrend}`}>
                                    <AnimatedValue value={downloadSpeed} />
                                    <span className="network-trend">
                                        {getTrendIcon(downloadTrend)}
                                    </span>
                                </div>
                                <div className="network-stat-total">ÊÄªËÆ° {totalRecv}</div>
                            </div>
                        </div>
                    )}

                    <div className="metrics-grid">
                        <MetricCard
                            label="CPU"
                            value={`${cpu}%`}
                            percent={cpu}
                            type="cpu"
                            total={`${cpuUsage} / ${cpuCores} Ê†∏`}
                        />
                        <MetricCard
                            label="ÂÜÖÂ≠ò"
                            value={`${memory}%`}
                            percent={memory}
                            type="memory"
                            total={`${memoryUsed} / ${totalMemory}`}
                        />
                        <MetricCard
                            label="Á£ÅÁõò"
                            value={`${disk}%`}
                            percent={disk}
                            type="disk"
                            total={`${diskUsed} / ${diskTotal}`}
                        />
                        <MetricCard
                            label="Ë¥üËΩΩ"
                            value={load}
                            percent={Math.min(load * 25, 100)}
                            type="cpu"
                            total={`${load} / ${cpuCores} Ê†∏`}
                        />
                    </div>
                </div>
            );
        };

        const Chart = ({ data, title, color, height = 280 }) => {
            const chartRef = useRef(null);
            const plotRef = useRef(null);

            useEffect(() => {
                if (!chartRef.current || !data || data.length === 0) return;

                const times = data.map(d => new Date(d.timestamp).getTime() / 1000);
                const values = data.map(d => {
                    if (title === 'CPU') return d.system?.cpu?.usage_percent || 0;
                    if (title === 'ÂÜÖÂ≠ò') return d.system?.memory?.usage_percent || 0;
                    if (title === '‰∏ä‰º†ÈÄüÂ∫¶') return d.system?.network ? (d.network_speed?.upload || 0) / 1024 / 1024 : 0;
                    if (title === '‰∏ãËΩΩÈÄüÂ∫¶') return d.system?.network ? (d.network_speed?.download || 0) / 1024 / 1024 : 0;
                    return 0;
                });

                const opts = {
                    width: chartRef.current.offsetWidth,
                    height: height,
                    legend: {
                        show: false,
                    },
                    series: [
                        {},
                        {
                            label: title,
                            stroke: color,
                            fill: color + '20',
                            width: 2,
                        }
                    ],
                    axes: [
                        {
                            stroke: '#9ca3af',
                            grid: { stroke: '#d1d5db', width: 1 },
                        },
                        {
                            stroke: '#9ca3af',
                            grid: { stroke: '#d1d5db', width: 1 },
                            size: 52,
                            font: '10px -apple-system, BlinkMacSystemFont, sans-serif',
                            values: (u, vals) => {
                                if (title.includes('ÈÄüÂ∫¶')) {
                                    return vals.map(v => v.toFixed(2) + ' MB/s');
                                }
                                return vals.map(v => v.toFixed(1) + '%');
                            },
                        }
                    ],
                    scales: {
                        x: { time: true },
                        y: { range: title.includes('ÈÄüÂ∫¶') ? undefined : [0, 100] },
                    },
                };

                if (plotRef.current) {
                    plotRef.current.destroy();
                }

                plotRef.current = new uPlot(opts, [times, values], chartRef.current);

                return () => {
                    if (plotRef.current) {
                        plotRef.current.destroy();
                    }
                };
            }, [data, title, color, height]);

            return <div ref={chartRef} className="chart-container" style={{height: height}}></div>;
        };

        // AgentModal Êîπ‰∏∫‰ΩøÁî® agentIdÔºå‰ªé agents Map ‰∏≠ÂÆûÊó∂Ëé∑ÂèñÊï∞ÊçÆ
        const AgentModal = ({ agentId, onClose, history, agents }) => {
            const agent = agents.get(agentId);

            useEffect(() => {
                const handleKeyDown = (event) => {
                    if (event.key === 'Escape') {
                        onClose();
                    }
                };

                document.addEventListener('keydown', handleKeyDown);
                return () => {
                    document.removeEventListener('keydown', handleKeyDown);
                };
            }, [onClose]);

            if (!agent) return null;

            const sys = agent.system;
            const agentMetrics = sys?.agent_metrics;
            const cpu = sys?.cpu?.usage_percent?.toFixed(1) || 0;
            const memory = sys?.memory?.usage_percent?.toFixed(1) || 0;
            const load = sys?.cpu?.load_avg_1?.toFixed(2) || 0;
            const uptime = formatUptime(sys?.system_info?.uptime);

            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <div>
                                <h2 className="modal-title">{agent.hostname}</h2>
                                <div className="modal-subtitle">{agent.agent_id}</div>
                            </div>
                            <button className="modal-close" onClick={onClose}>&times;</button>
                        </div>
                        <div className="modal-body">
                            {/* ‰∏ª‰ª™Ë°®Áõò */}
                            <div className="dashboard-grid">
                                <div className="dashboard-card">
                                    <div className="dashboard-card-title">
                                        <span>üñ•Ô∏è</span> CPU ‰ΩøÁî®Áéá
                                    </div>
                                    <div className="dashboard-card-value">
                                        <AnimatedNumber value={parseFloat(cpu)} duration={600} decimals={1} />%
                                    </div>
                                    <div className="dashboard-card-subtitle">
                                        {sys?.cpu?.core_count || 'N/A'} Ê†∏ÂøÉ ¬∑ Ë¥üËΩΩ {load}
                                    </div>
                                    <div className="metric-bar" style={{marginTop: '12px'}}>
                                        <div className="metric-bar-fill cpu" style={{width: `${cpu}%`}} />
                                    </div>
                                </div>

                                <div className="dashboard-card">
                                    <div className="dashboard-card-title">
                                        <span>üíæ</span> ÂÜÖÂ≠ò‰ΩøÁî®Áéá
                                    </div>
                                    <div className="dashboard-card-value">
                                        <AnimatedNumber value={parseFloat(memory)} duration={600} decimals={1} />%
                                    </div>
                                    <div className="dashboard-card-subtitle">
                                        {formatBytes(sys?.memory?.used)} / {formatBytes(sys?.memory?.total)}
                                    </div>
                                    <div className="metric-bar" style={{marginTop: '12px'}}>
                                        <div className="metric-bar-fill memory" style={{width: `${memory}%`}} />
                                    </div>
                                </div>

                                <div className="dashboard-card">
                                    <div className="dashboard-card-title">
                                        <span>üíø</span> Á£ÅÁõò‰ΩøÁî®
                                    </div>
                                    <div className="dashboard-card-value">
                                        {sys?.disks?.[0]?.usage_percent?.toFixed(1) || 0}%
                                    </div>
                                    <div className="dashboard-card-subtitle">
                                        {formatBytes(sys?.disks?.[0]?.used)} / {formatBytes(sys?.disks?.[0]?.total)}
                                    </div>
                                    <div className="metric-bar" style={{marginTop: '12px'}}>
                                        <div className="metric-bar-fill disk" style={{width: `${sys?.disks?.[0]?.usage_percent || 0}%`}} />
                                    </div>
                                </div>

                                <div className="dashboard-card">
                                    <div className="dashboard-card-title">
                                        <span>‚è±Ô∏è</span> ËøêË°åÊó∂Èó¥
                                    </div>
                                    <div className="dashboard-card-value" style={{fontSize: '16px'}}>
                                        {uptime}
                                    </div>
                                    <div className="dashboard-card-subtitle">
                                        {sys?.system_info?.os_name} {sys?.system_info?.arch}
                                    </div>
                                </div>

                                <div className="dashboard-card">
                                    <div className="dashboard-card-title">
                                        <span>‚¨ÜÔ∏è</span> ‰∏ä‰º†ÈÄüÂ∫¶
                                    </div>
                                    <div className="dashboard-card-value" style={{fontSize: '16px'}}>
                                        {formatSpeed(agent.network_speed?.upload || 0)}
                                    </div>
                                    <div className="dashboard-card-subtitle">
                                        ÊÄªËÆ° {formatBytesShort(sys?.network?.bytes_sent)}
                                    </div>
                                </div>

                                <div className="dashboard-card">
                                    <div className="dashboard-card-title">
                                        <span>‚¨áÔ∏è</span> ‰∏ãËΩΩÈÄüÂ∫¶
                                    </div>
                                    <div className="dashboard-card-value" style={{fontSize: '16px'}}>
                                        {formatSpeed(agent.network_speed?.download || 0)}
                                    </div>
                                    <div className="dashboard-card-subtitle">
                                        ÊÄªËÆ° {formatBytesShort(sys?.network?.bytes_recv)}
                                    </div>
                                </div>
                            </div>

                            {/* ÂõæË°®ÁΩëÊ†º */}
                            <div className="charts-row">
                                <div className="chart-card">
                                    <div className="chart-card-header">
                                        <div className="chart-card-title">
                                            <span>üìà</span> CPU ‰ΩøÁî®Áéá
                                        </div>
                                        <div className="chart-card-value" style={{fontSize: '18px', color: '#0066ff'}}>
                                            {cpu}%
                                        </div>
                                    </div>
                                    <div className="chart-card-body">
                                        <Chart data={history} title="CPU" color="#0066ff" height={140} />
                                    </div>
                                </div>

                                <div className="chart-card">
                                    <div className="chart-card-header">
                                        <div className="chart-card-title">
                                            <span>üìä</span> ÂÜÖÂ≠ò‰ΩøÁî®Áéá
                                        </div>
                                        <div className="chart-card-value" style={{fontSize: '18px', color: '#f59e0b'}}>
                                            {memory}%
                                        </div>
                                    </div>
                                    <div className="chart-card-body">
                                        <Chart data={history} title="ÂÜÖÂ≠ò" color="#f59e0b" height={140} />
                                    </div>
                                </div>

                                <div className="chart-card">
                                    <div className="chart-card-header">
                                        <div className="chart-card-title">
                                            <span>üîº</span> ‰∏ä‰º†ÈÄüÂ∫¶
                                        </div>
                                        <div className="chart-card-value" style={{fontSize: '18px', color: '#10b981'}}>
                                            {formatSpeed(agent.network_speed?.upload || 0)}
                                        </div>
                                    </div>
                                    <div className="chart-card-body">
                                        <Chart data={history} title="‰∏ä‰º†ÈÄüÂ∫¶" color="#10b981" height={140} />
                                    </div>
                                </div>

                                <div className="chart-card">
                                    <div className="chart-card-header">
                                        <div className="chart-card-title">
                                            <span>üîΩ</span> ‰∏ãËΩΩÈÄüÂ∫¶
                                        </div>
                                        <div className="chart-card-value" style={{fontSize: '18px', color: '#8b5cf6'}}>
                                            {formatSpeed(agent.network_speed?.download || 0)}
                                        </div>
                                    </div>
                                    <div className="chart-card-body">
                                        <Chart data={history} title="‰∏ãËΩΩÈÄüÂ∫¶" color="#8b5cf6" height={140} />
                                    </div>
                                </div>
                            </div>

                            {/* Êé¢ÈíàËµÑÊ∫êÂç†Áî® */}
                            {agentMetrics && (
                                <div className="section">
                                    <h3 className="section-title">
                                        <span className="icon">üì°</span>
                                        Êé¢ÈíàËµÑÊ∫êÂç†Áî®
                                    </h3>
                                    <div className="info-grid">
                                        <div className="info-item">
                                            <div className="info-item-label">CPU ‰ΩøÁî®Áéá</div>
                                            <div className="info-item-value">{agentMetrics.cpu_usage?.toFixed(2)}%</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">ÂÜÖÂ≠ò‰ΩøÁî®</div>
                                            <div className="info-item-value">{formatBytes(agentMetrics.memory_usage)}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">ÈááÈõÜËÄóÊó∂</div>
                                            <div className="info-item-value">{agentMetrics.collection_time_ms} ms</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">ËøêË°åÊó∂Èïø</div>
                                            <div className="info-item-value">{formatUptime(agentMetrics.uptime_seconds)}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">Â∑≤ÂèëÈÄÅÊåáÊ†á</div>
                                            <div className="info-item-value">{agentMetrics.metrics_sent}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">ÈîôËØØÊ¨°Êï∞</div>
                                            <div className="info-item-value">{agentMetrics.errors_count}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Á≥ªÁªü‰ø°ÊÅØ */}
                            {sys?.system_info && (
                                <div className="section">
                                    <h3 className="section-title">
                                        <span className="icon">‚öôÔ∏è</span>
                                        Á≥ªÁªü‰ø°ÊÅØ
                                    </h3>
                                    <div className="info-grid">
                                        <div className="info-item">
                                            <div className="info-item-label">Êìç‰ΩúÁ≥ªÁªü</div>
                                            <div className="info-item-value">{sys.system_info.os_name}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">Á≥ªÁªüÁâàÊú¨</div>
                                            <div className="info-item-value">{sys.system_info.os_version}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">Êû∂ÊûÑ</div>
                                            <div className="info-item-value">{sys.system_info.arch}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">CPU ÂûãÂè∑</div>
                                            <div className="info-item-value">{sys.system_info.cpu_model || 'N/A'}</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">CPU È¢ëÁéá</div>
                                            <div className="info-item-value">{sys.system_info.cpu_frequency?.toFixed(0) || 'N/A'} MHz</div>
                                        </div>
                                        <div className="info-item">
                                            <div className="info-item-label">‰∏ªÊú∫Âêç</div>
                                            <div className="info-item-value">{sys.system_info.hostname || agent.hostname}</div>
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>
                </div>
            );
        };

        // Main App
        const App = () => {
            const [agents, setAgents] = useState(new Map());
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedAgent, setSelectedAgent] = useState(null);
            const [history, setHistory] = useState([]);
            const [agentHistories, setAgentHistories] = useState(new Map()); // Â≠òÂÇ®ÊØè‰∏™ agent ÁöÑÂéÜÂè≤Êï∞ÊçÆ
            const [historyLoadedAgents, setHistoryLoadedAgents] = useState(new Set()); // Ê†áËÆ∞Âì™‰∫õ agent Â∑≤‰ªéÊúçÂä°Á´ØÂä†ËΩΩËøáÂéÜÂè≤
            const eventSourceRef = useRef(null);

            const updateAgent = useCallback((metrics) => {
                setAgents(prev => {
                    const newAgents = new Map(prev);
                    const agentId = metrics.agent_id;
                    const prevAgent = prev.get(agentId);

                    // ËÆ°ÁÆóÁΩëÁªúÈÄüÂ∫¶
                    let networkSpeed = { upload: 0, download: 0 };
                    let prevSpeed = { upload: 0, download: 0 };

                    if (prevAgent?.system?.network && metrics.system?.network) {
                        const prevNet = prevAgent.system.network;
                        const currNet = metrics.system.network;
                        const prevTime = new Date(prevAgent.timestamp).getTime();
                        const currTime = new Date(metrics.timestamp).getTime();
                        const timeDiff = (currTime - prevTime) / 1000; // Áßí

                        if (timeDiff > 0 && timeDiff < 60) { // Âè™Âú®ÂêàÁêÜÁöÑÊó∂Èó¥Â∑ÆÂÜÖËÆ°ÁÆó
                            const uploadDiff = currNet.bytes_sent - prevNet.bytes_sent;
                            const downloadDiff = currNet.bytes_recv - prevNet.bytes_recv;

                            networkSpeed = {
                                upload: Math.max(0, uploadDiff / timeDiff),
                                download: Math.max(0, downloadDiff / timeDiff)
                            };
                        }

                        // ‰øùÂ≠ò‰∏ä‰∏ÄÊ¨°ÁöÑÈÄüÂ∫¶Áî®‰∫éÊØîËæÉË∂ãÂäø
                        prevSpeed = prevAgent.network_speed || { upload: 0, download: 0 };
                    }

                    const updatedMetrics = {
                        ...metrics,
                        network_speed: networkSpeed,
                        prev_network_speed: prevSpeed
                    };

                    newAgents.set(agentId, updatedMetrics);

                    // ÂêåÊó∂Êõ¥Êñ∞ËØ• agent ÁöÑÂéÜÂè≤Êï∞ÊçÆÔºàËøΩÂä†Êñ∞Êï∞ÊçÆÔºâ
                    setAgentHistories(prevHistories => {
                        const newHistories = new Map(prevHistories);
                        const agentHistory = newHistories.get(agentId) || [];

                        // ËøΩÂä†Êñ∞Êï∞ÊçÆÔºå‰øùÊåÅÊúÄÊñ∞ 100 Êù°
                        const updatedHistory = [...agentHistory, updatedMetrics].slice(-100);
                        newHistories.set(agentId, updatedHistory);

                        return newHistories;
                    });

                    return newAgents;
                });
            }, []);

            const mergeHistory = useCallback((serverHistory, cachedHistory) => {
                const merged = [...(serverHistory || []), ...(cachedHistory || [])];
                const deduped = new Map();

                for (const item of merged) {
                    if (!item) continue;
                    const key = `${item.agent_id}-${item.timestamp}`;
                    const existing = deduped.get(key);

                    // ‰ºòÂÖà‰øùÁïôÂ∏¶ network_speed ÁöÑËÆ∞ÂΩïÔºàÈÄöÂ∏∏Êù•Ëá™ÂÆûÊó∂ÊµÅÔºâ
                    if (!existing || (item.network_speed && !existing.network_speed)) {
                        deduped.set(key, item);
                    }
                }

                return Array.from(deduped.values())
                    .sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0))
                    .slice(-100);
            }, []);

            const connectSSE = useCallback(() => {
                eventSourceRef.current = new EventSource('/api/stream');

                eventSourceRef.current.onmessage = (event) => {
                    try {
                        const metrics = JSON.parse(event.data);
                        updateAgent(metrics);
                    } catch (err) {
                        console.error('Ëß£Êûê SSE Êï∞ÊçÆÂ§±Ë¥•:', err);
                    }
                };

                eventSourceRef.current.onerror = () => {
                    eventSourceRef.current.close();
                    setTimeout(connectSSE, 3000);
                };
            }, [updateAgent]);

            useEffect(() => {
                const init = async () => {
                    try {
                        const response = await fetch('/api/agents');
                        const data = await response.json();

                        if (data.success) {
                            for (const agent of data.data) {
                                const metricsRes = await fetch(`/api/agents/${agent.agent_id}/metrics`);
                                const metricsData = await metricsRes.json();
                                if (metricsData.success) {
                                    updateAgent(metricsData.data);
                                }
                            }
                            setError(null);
                        }
                    } catch (err) {
                        setError('Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®');
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }

                    connectSSE();
                };

                init();

                return () => {
                    if (eventSourceRef.current) {
                        eventSourceRef.current.close();
                    }
                };
            }, [connectSSE, updateAgent]);

            const handleAgentClick = async (agent) => {
                setSelectedAgent(agent.agent_id);  // Âè™‰øùÂ≠ò IDÔºåModal ‰ºö‰ªé agents Map ‰∏≠ÂÆûÊó∂Ëé∑Âèñ

                const cachedHistory = agentHistories.get(agent.agent_id);
                const hasLoadedHistory = historyLoadedAgents.has(agent.agent_id);

                // Â∑≤ÁªèÂä†ËΩΩËøáÊúçÂä°Á´ØÂéÜÂè≤ÔºöÁõ¥Êé•‰ΩøÁî®ÁºìÂ≠òÔºàÂê´ÂÆûÊó∂Êõ¥Êñ∞Ôºâ
                if (hasLoadedHistory && cachedHistory && cachedHistory.length > 0) {
                    setHistory(cachedHistory);
                } else {
                    // È¶ñÊ¨°ÊâìÂºÄÔºö‰ªéÊúçÂä°Á´ØÊãâÂéÜÂè≤ÔºåÂÜç‰∏éÊú¨Âú∞ÂÆûÊó∂ÁºìÂ≠òÂêàÂπ∂
                    try {
                        const historyRes = await fetch(`/api/agents/${agent.agent_id}/metrics/history?limit=100`);
                        const historyData = await historyRes.json();
                        if (historyData.success) {
                            const mergedHistory = mergeHistory(historyData.data, cachedHistory);
                            setHistory(mergedHistory);

                            setAgentHistories(prev => {
                                const newHistories = new Map(prev);
                                newHistories.set(agent.agent_id, mergedHistory);
                                return newHistories;
                            });
                            setHistoryLoadedAgents(prev => {
                                const newLoaded = new Set(prev);
                                newLoaded.add(agent.agent_id);
                                return newLoaded;
                            });
                        }
                    } catch (err) {
                        console.error('Ëé∑ÂèñÂéÜÂè≤Êï∞ÊçÆÂ§±Ë¥•:', err);
                        if (cachedHistory && cachedHistory.length > 0) {
                            setHistory(cachedHistory);
                        }
                    }
                }
            };

            const agentsList = Array.from(agents.values());
            const now = Date.now();
            const onlineAgents = agentsList.filter(agent => {
                const lastSeen = agent.timestamp * 1000;
                return (now - lastSeen) < 10000; // 10 ÁßíË∂ÖÊó∂
            });
            const offlineAgents = agentsList.filter(agent => {
                const lastSeen = agent.timestamp * 1000;
                return (now - lastSeen) >= 10000; // 10 ÁßíË∂ÖÊó∂
            });

            return (
                <div className="app">
                    <header className="header">
                        <div className="header-content">
                            <div className="header-title">
                                <h1>Iris</h1>
                                <span className="header-badge">ÁõëÊéßÈù¢Êùø</span>
                            </div>
                            <div className="header-badge">{new Date().toLocaleTimeString('zh-CN')}</div>
                        </div>
                    </header>

                    <div className="container">
                        <div className="stats-grid">
                            <StatusCard
                                onlineCount={onlineAgents.length}
                                offlineCount={offlineAgents.length}
                                agents={onlineAgents}
                            />
                        </div>

                        {loading && (
                            <div className="loading">
                                <div className="loading-spinner"></div>
                                <p>Âä†ËΩΩ‰∏≠...</p>
                            </div>
                        )}

                        {error && <div className="error">{error}</div>}

                        <div className="agents-grid">
                            {agentsList.map(agent => (
                                <AgentCard key={agent.agent_id} agent={agent} onClick={handleAgentClick} />
                            ))}
                        </div>
                    </div>

                    {selectedAgent && (
                        <AgentModal
                            agentId={selectedAgent}
                            history={agentHistories.get(selectedAgent) || history}
                            agents={agents}
                            onClose={() => setSelectedAgent(null)}
                        />
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
